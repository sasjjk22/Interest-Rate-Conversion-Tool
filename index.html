<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»ˆæå…¨èƒ½è®¡ç®—å™¨ (å«å¯¼å‡ºåŠŸèƒ½)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- æ ¸å¿ƒ UI æ ·å¼ --- */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, "Microsoft YaHei", sans-serif; background-color: #eef2f5; display: flex; justify-content: center; padding-top: 20px; margin: 0; color: #333; }
        .container { background: white; width: 94%; max-width: 640px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); overflow: hidden; margin-bottom: 50px; display: flex; flex-direction: column; }
        
        /* å¤´éƒ¨ä»‹ç»æ ·å¼ */
        .header-section { padding: 25px 20px 15px; background: #f0f7ff; text-align: center; border-bottom: 1px solid #dce0e5; }
        .header-section h1 { margin: 0 0 5px; font-size: 24px; color: #007BFF; }
        .header-section p { margin: 0; font-size: 14px; color: #666; }

        /* å¯¼èˆª */
        .tabs { display: flex; background: #fff; border-bottom: 1px solid #eee; overflow-x: auto; }
        .tab-btn { flex: 1; min-width: 80px; padding: 15px 5px; border: none; background: transparent; cursor: pointer; font-size: 14px; font-weight: 600; color: #666; white-space: nowrap; transition: 0.2s; }
        .tab-btn:hover { background: #f5faff; color: #007BFF; }
        .tab-btn.active { color: #007BFF; border-bottom: 3px solid #007BFF; background: #f0f7ff; }
        
        /* å†…å®¹åŒº */
        .content { padding: 20px; display: none; animation: fadeIn 0.3s; }
        .content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* è¡¨å•æ§ä»¶ */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; color: #555; }
        input, select { width: 100%; padding: 12px; border: 1px solid #dce0e5; border-radius: 8px; font-size: 16px; outline: none; box-sizing: border-box; background: #fff; }
        input:focus, select:focus { border-color: #007BFF; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        
        /* æŒ‰é’® */
        button.action-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #007BFF, #0062cc); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: transform 0.1s; }
        button.action-btn:active { transform: scale(0.98); }
        
        /* å¯¼å‡ºæŒ‰é’® (ç»¿è‰²) */
        button.export-btn { width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        button.export-btn:hover { background: #218838; }

        /* ç»“æœåŒºåŸŸ */
        .result-box { margin-top: 20px; padding: 15px; background: #f7fdf9; border: 1px solid #c3e6cb; border-radius: 10px; display: none; }
        .result-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
        .result-item strong { color: #28a745; font-size: 1.1em; }

        /* æå‰è¿˜æ¬¾ç»“æœæ ·å¼ */
        .early-repay-result { margin-top: 15px; padding: 10px; background: #fff8e1; border: 1px solid #ffe0b2; border-radius: 8px; font-weight: 600; color: #e6a23c; display: none; }
        .early-repay-result span { color: #555; font-weight: normal; }

        /* å¯¹æ¯”ç»“æœæ ·å¼ */
        .comparison-box { background: #e0f7fa; border-color: #b2ebf2; margin-top: 15px; }
        .comparison-box h4 { color: #0097a7 !important; }
        .comparison-box .result-item strong { color: #0097a7; }

        /* å›¾è¡¨å®¹å™¨ */
        .chart-wrapper { position: relative; height: 220px; width: 100%; margin-top: 20px; display: none; justify-content: center; }
        
        /* è¿˜æ¬¾è®¡åˆ’è¡¨æ ·å¼ */
        .schedule-container { margin-top: 20px; max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; display: none; }
        table.schedule-tbl { width: 100%; border-collapse: collapse; font-size: 12px; text-align: center; }
        table.schedule-tbl th { background: #f1f3f5; padding: 10px; position: sticky; top: 0; z-index: 1; color: #444; }
        table.schedule-tbl td { padding: 8px; border-bottom: 1px solid #eee; color: #666; }
        table.schedule-tbl tr:nth-child(even) { background-color: #fafbfc; }
        
        /* åæ¨æ ·å¼ */
        .reverse-box { background: #fff9db; border-color: #ffeeba; }
        .reverse-box .result-item strong { color: #e6a23c; }

        /* æ±‡ç‡å¤šç»“æœæ ·å¼ */
        #forexMultiResult { margin-top: 15px; padding-top: 10px; border-top: 1px dashed #eee; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; }
        .forex-item { display: flex; justify-content: space-between; }
        .forex-item strong { color: #007BFF; }

        /* é€šç”¨ä¸¤åˆ—å¸ƒå±€ */
        .row-input { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .row-input input { flex: 2; }
        .row-input select { flex: 1; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <h1>ğŸš€ ç»ˆæå…¨èƒ½è®¡ç®—å·¥å…·ç®±</h1>
        <p>é›†æˆ¿è´·æ˜ç»†ã€åˆ©ç‡åæ¨ã€å®æ—¶æ±‡ç‡ä¸å·¥ç¨‹å•ä½æ¢ç®—äºä¸€ä½“ã€‚</p>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('loan')">ğŸ  æˆ¿è´·æ˜ç»†</button>
        <button class="tab-btn" onclick="switchTab('reverse')">ğŸ“‰ åæ¨åˆ©ç‡</button>
        <button class="tab-btn" onclick="switchTab('forex')">ğŸ’± æ±‡ç‡</button>
        <button class="tab-btn" onclick="switchTab('unit')">âš–ï¸ å·¥ç¨‹æ¢ç®—</button>
    </div>

    <div id="loan" class="content active">
        <div class="form-group">
            <label>è¿˜æ¬¾æ–¹å¼</label>
            <select id="repaymentMethod">
                <option value="equal_payment">ç­‰é¢æœ¬æ¯ (æ¯æœˆå›ºå®š)</option>
                <option value="equal_principal">ç­‰é¢æœ¬é‡‘ (é€æœˆé€’å‡)</option>
            </select>
        </div>
        <div class="form-group">
            <label>è´·æ¬¾é‡‘é¢ (ä¸‡å…ƒ)</label>
            <input type="number" id="loanAmount" placeholder="100" value="" min="0">
        </div>
        <div class="form-group">
            <label>å¹´åˆ©ç‡ (%)</label>
            <input type="number" id="loanRate" placeholder="3.2" value="" min="0">
        </div>
        <div class="form-group">
            <label>æœŸé™ (å¹´)</label>
            <input type="number" id="loanYears" placeholder="30" value="" min="0">
        </div>

        <h4 style="margin: 20px 0 10px; color:#555; border-left: 4px solid #FFA000; padding-left: 10px;">ä¸€æ¬¡æ€§æå‰è¿˜æ¬¾ (å¯é€‰)</h4>
        <div class="form-group">
            <label>æå‰è¿˜æ¬¾æœŸæ•° (æœˆ) / é‡‘é¢ (ä¸‡å…ƒ)</label>
            <div class="row-input">
                <input type="number" id="earlyRepayMonth" placeholder="ä¾‹å¦‚ 24" min="1">
                <input type="number" id="earlyRepayAmount" placeholder="ä¾‹å¦‚ 10" min="0">
            </div>
        </div>
         <div class="form-group">
            <label>è¿˜æ¬¾åå¤„ç†æ–¹å¼</label>
            <select id="recalculateOption">
                <option value="reduce_term">ç¼©çŸ­è¿˜æ¬¾æœŸé™ (æœˆä¾›ä¸å˜)</option>
                <option value="reduce_payment">å‡å°‘æ¯æœˆæœˆä¾› (æœŸé™ä¸å˜)</option>
            </select>
        </div>
        <button class="action-btn" onclick="calculateLoan()">å¼€å§‹è®¡ç®— & ç”Ÿæˆè®¡åˆ’è¡¨</button>

        <div id="comparisonResult" class="comparison-box result-box">
            <h4 style="margin: 0 0 10px; border-left: 4px solid #0097a7; padding-left: 8px;">æ–¹å¼å¯¹æ¯” (ç­‰é¢æœ¬æ¯ vs ç­‰é¢æœ¬é‡‘)</h4>
            <div class="result-item">
                <span>æ€»åˆ©æ¯å·®é¢ï¼š</span><strong id="compInterestDiff">0 ä¸‡å…ƒ</strong>
            </div>
            <div class="result-item">
                <span>é¦–æœˆè¿˜æ¬¾å·®é¢ï¼š</span><strong id="compFirstPayDiff">0 å…ƒ</strong>
            </div>
        </div>

        <div id="loanResult" class="result-box">
            <div class="result-item"><span>é¦–æœˆè¿˜æ¬¾ï¼š</span><strong id="monthlyPayment">0 å…ƒ</strong></div>
            <div class="result-item"><span>æ€»åˆ©æ¯ï¼š</span><strong id="totalInterest">0 ä¸‡å…ƒ</strong></div>
            <div class="result-item"><span>æœ¬æ¯åˆè®¡ï¼š</span><strong id="totalPayment">0 ä¸‡å…ƒ</strong></div>

            <div id="earlyRepayResult" class="early-repay-result">
                æå‰è¿˜æ¬¾æ•ˆæœï¼š<span id="repaySavings"></span>
            </div>
            
            <button class="export-btn" onclick="exportCSV()">ğŸ“¥ å¯¼å‡ºè¿˜æ¬¾è®¡åˆ’ (Excel/CSV)</button>

            <div class="chart-wrapper" id="chartBox">
                <canvas id="loanChart"></canvas>
            </div>

            <h4 style="margin: 20px 0 10px; color:#555; border-left: 4px solid #007BFF; padding-left: 10px;">æœˆåº¦è¿˜æ¬¾è¯¦æƒ… (ä¸‹æ‹‰æŸ¥çœ‹)</h4>
            <div class="schedule-container" id="scheduleBox">
                <table class="schedule-tbl" id="scheduleTable">
                    <thead>
                        <tr>
                            <th>æœŸæ•°</th>
                            <th>æœ¬é‡‘</th>
                            <th>åˆ©æ¯</th>
                            <th>æœ¬æœŸåˆè®¡</th>
                            <th>å‰©ä½™æœ¬é‡‘</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="reverse" class="content">
        <div style="background:#eef; padding:10px; border-radius:6px; font-size:13px; color:#557; margin-bottom:15px;">
            ğŸ’¡ è¾“å…¥è´·æ¬¾å‚æ•°å’Œç›®æ ‡ç»“æœï¼Œåç®—å®é™…å¹´åŒ–åˆ©ç‡ã€‚
        </div>
        <div class="form-group">
            <label>ç›®æ ‡åæ¨æ¨¡å¼</label>
            <select id="revMode" onchange="updateRevInputs()">
                <option value="target_interest">åæ¨ï¼šå·²çŸ¥æ€»åˆ©æ¯</option>
                <option value="target_monthly_payment">åæ¨ï¼šå·²çŸ¥æ¯æœˆæœˆä¾›</option>
            </select>
        </div>
        <div class="form-group">
            <label>æ–¹å¼</label>
            <select id="revMethod">
                <option value="equal_payment">ç­‰é¢æœ¬æ¯</option>
                <option value="equal_principal">ç­‰é¢æœ¬é‡‘</option>
            </select>
        </div>
        <div class="form-group">
            <label>æœ¬é‡‘ (ä¸‡å…ƒ)</label>
            <input type="number" id="revPrincipal" placeholder="ä¾‹å¦‚ 100" min="0">
        </div>
        <div class="form-group">
            <label>æœŸé™ (å¹´)</label>
            <input type="number" id="revYears" placeholder="ä¾‹å¦‚ 30" min="0">
        </div>
        <div class="form-group" id="inputInterest">
            <label>æ€»åˆ©æ¯ (ä¸‡å…ƒ)</label>
            <input type="number" id="revInterest" placeholder="ä¾‹å¦‚ 0.7" min="0">
        </div>
        <div class="form-group" id="inputMonthly" style="display:none;">
            <label>æ¯æœˆæœˆä¾› (å…ƒ)</label>
            <input type="number" id="revMonthly" placeholder="ä¾‹å¦‚ 4500" min="0">
        </div>
        <button class="action-btn" onclick="calculateReverseRate()" style="background: linear-gradient(135deg, #f6d365, #fda085); color:#444;">åå‘æ¨ç®—</button>

        <div id="revResult" class="result-box reverse-box">
            <div class="result-item"><span>æ¨ç®—å¹´åˆ©ç‡ï¼š</span><strong id="revRateResult">0.00%</strong></div>
            <div class="result-item"><span>æ€»è¿˜æ¬¾éªŒè¯ï¼š</span><strong id="revTotalPay">0 ä¸‡å…ƒ</strong></div>
            <div class="result-item"><span>æ¨ç®—ç»“æœè¡¥å……ï¼š</span><strong id="revOtherResult">--</strong></div>
        </div>
    </div>

    <div id="forex" class="content">
        <div class="form-group">
            <label>æŒæœ‰é‡‘é¢</label>
            <div class="row-input">
                <input type="number" id="forexAmount" value="100" oninput="calculateForex()">
                <select id="fromCurrency" onchange="calculateForex()"></select>
            </div>
        </div>
        <div style="text-align:center; color:#ccc;">â¬‡ï¸</div>
        <div class="form-group">
            <label>ç›®æ ‡è´§å¸ (ä¸»ç»“æœ)</label>
            <div class="row-input">
                <input type="text" id="forexResult" readonly style="background:#f4f4f4;">
                <select id="toCurrency" onchange="calculateForex()"></select>
            </div>
        </div>
        <p style="text-align:center; font-size:12px; color:#999;" id="rateStatus">åŠ è½½ä¸­...</p>
        <button class="action-btn" onclick="fetchRates()" style="background:#28a745;">åˆ·æ–°æ±‡ç‡</button>

        <h4 style="margin: 20px 0 10px; color:#555; border-left: 4px solid #28a745; padding-left: 10px;">å…¶ä»–ä¸»è¦è´§å¸æ¢ç®—</h4>
        <div id="forexMultiResult"></div>
    </div>

    <div id="unit" class="content">
        <div class="form-group">
            <label>ç‰©ç†é‡ç±»å‹</label>
            <select id="unitType" onchange="updateUnitOptions()">
                <option value="pressure">ğŸŒ¡ï¸ å‹åŠ› (Pressure)</option>
                <option value="flow">ğŸ’§ æµé‡ (Flow Rate)</option>
                <option value="velocity">ğŸš€ æµé€Ÿ (Velocity)</option>
                <option value="length">ğŸ“ é•¿åº¦ (Length)</option>
                <option value="weight">âš–ï¸ é‡é‡ (Weight)</option>
                <option value="area">â¬› é¢ç§¯ (Area)</option>
                <option value="volume">ğŸ§Š ä½“ç§¯ (Volume)</option>
                <option value="data">ğŸ’¾ æ•°æ® (Data) [1024]</option>
                <option value="time">â³ æ—¶é—´ (Time)</option>
                <option value="energy">ğŸ”‹ èƒ½é‡/åŠŸ (Energy)</option>
                <option value="power">âš¡ åŠŸç‡ (Power)</option> 
                <option value="temperature">ğŸ”¥ æ¸©åº¦ (Temperature)</option>
                <option value="force">ğŸ’ª åŠ› (Force)</option> 
            </select>
        </div>
        <div class="row-input">
            <input type="number" id="inputVal" placeholder="è¾“å…¥" oninput="convertUnit()">
            <select id="fromUnit" onchange="convertUnit()"></select>
        </div>
        <div class="row-input">
            <input type="text" id="outputVal" readonly placeholder="ç»“æœ" style="background:#f4f4f4;">
            <select id="toUnit" onchange="convertUnit()"></select>
        </div>
    </div>
</div>

<script>
    /* --- å…¨å±€çŠ¶æ€ä¸è¾…åŠ© --- */
    window.currentScheduleData = []; // å­˜å‚¨è¿˜æ¬¾è®¡åˆ’æ•°æ®ç”¨äºå¯¼å‡º

    function switchTab(name) {
        document.querySelectorAll('.content').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
        const clickedButton = event.currentTarget;
        document.getElementById(name).classList.add('active');
        clickedButton.classList.add('active');
        if(name === 'forex' && !window.ratesLoaded) fetchRates(); 
    }

    function escapeHTML(str) {
        if (typeof str !== 'string') return str;
        return str.replace(/[&<>"']/g, function(match) {
            return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[match];
        });
    }

    /* --- 1. æˆ¿è´·æ ¸å¿ƒè®¡ç®—ä¸å¯¼å‡º --- */
    function getLoanMetrics(P, r, n, type) {
        let totalPay = 0, totalInt = 0, firstPay = 0;
        if (P <= 0 || n <= 0 || r < 0) return { firstPayment: 0, totalInterest: 0, totalPayment: 0 };
        if (type === 'equal_payment') {
            if (r === 0) { totalInt = 0; totalPay = P; firstPay = P / n; } 
            else { let term = Math.pow(1 + r, n); let monthly = P * r * term / (term - 1); firstPay = monthly; totalPay = monthly * n; totalInt = totalPay - P; }
        } else {
            let principalMonth = P / n; firstPay = principalMonth + P * r; totalInt = ((n + 1) * P * r) / 2; totalPay = P + totalInt;
        }
        return { firstPayment: firstPay, totalInterest: totalInt, totalPayment: totalPay };
    }
    
    let chartInstance = null;
    function calculateLoan() {
        // æ¸…é™¤æ—§æ•°æ®
        window.currentScheduleData = [];

        let P_orig = parseFloat(document.getElementById('loanAmount').value) * 10000;
        let R = parseFloat(document.getElementById('loanRate').value) / 100; 
        let r = R / 12; 
        let n_orig = parseFloat(document.getElementById('loanYears').value) * 12;
        let type = document.getElementById('repaymentMethod').value;
        
        // æå‰è¿˜æ¬¾
        let repayMonth = parseInt(document.getElementById('earlyRepayMonth').value) || n_orig + 1;
        let repayAmount = parseFloat(document.getElementById('earlyRepayAmount').value) * 10000 || 0;
        let recalculateOption = document.getElementById('recalculateOption').value;

        // æ ¡éªŒï¼šé˜²ç©ºå€¼ã€é˜²è´Ÿæ•°
        if (isNaN(P_orig) || isNaN(R) || isNaN(n_orig)) { alert("è¯·è¾“å…¥å®Œæ•´çš„è´·æ¬¾ä¿¡æ¯"); return; }
        if (P_orig <= 0 || R < 0 || n_orig <= 0) { alert("è´·æ¬¾é‡‘é¢ã€åˆ©ç‡å’ŒæœŸé™å¿…é¡»å¤§äº0"); return; }
        if (repayMonth < 1 || repayAmount < 0) { alert("æå‰è¿˜æ¬¾ä¿¡æ¯è¾“å…¥æœ‰è¯¯"); return; }

        // å¯¹æ¯”é€»è¾‘
        const metricsEP = getLoanMetrics(P_orig, r, n_orig, 'equal_payment');
        const metricsEO = getLoanMetrics(P_orig, r, n_orig, 'equal_principal');
        const intDiff = (metricsEP.totalInterest - metricsEO.totalInterest) / 10000;
        const payDiff = metricsEP.firstPayment - metricsEO.firstPayment;

        document.getElementById('compInterestDiff').innerText = `${Math.abs(intDiff).toFixed(2)} ä¸‡å…ƒ (${intDiff > 0 ? 'æœ¬æ¯é«˜äºæœ¬é‡‘' : 'æœ¬é‡‘ä½äºæœ¬æ¯'})`;
        document.getElementById('compFirstPayDiff').innerText = `${Math.abs(payDiff).toFixed(2)} å…ƒ (${payDiff > 0 ? 'æœ¬æ¯é«˜äºæœ¬é‡‘' : 'æœ¬é‡‘ä½äºæœ¬æ¯'})`;
        document.getElementById('comparisonResult').style.display = 'block';

        let totalPay = 0, totalInt = 0, firstPay = 0;
        let balance = P_orig;
        let monthly = metricsEP.firstPayment; 
        let principalMonth = P_orig / n_orig; 
        let n = n_orig;

        let originalTotalInterest = (type === 'equal_payment' ? metricsEP.totalInterest : metricsEO.totalInterest);
        firstPay = (type === 'equal_payment' ? metricsEP.firstPayment : metricsEO.firstPayment);

        let P_new = 0;
        let n_new = n_orig;
        let monthly_new = monthly;
        let earlyRepayApplied = false;
        
        // ç”Ÿæˆè®¡åˆ’è¡¨æ•°æ®
        for(let i=1; i<=n_orig; i++) {
            let curPay = 0, interest = 0, principal = 0;

            if (type === 'equal_payment') {
                if (i <= repayMonth && !earlyRepayApplied) {
                    interest = balance * r; principal = monthly - interest; curPay = monthly;
                } else if (earlyRepayApplied) {
                    if (recalculateOption === 'reduce_payment') { interest = balance * r; principal = monthly_new - interest; curPay = monthly_new; } 
                    else { if (i > n_new) break; interest = balance * r; principal = monthly_new - interest; curPay = monthly_new; }
                }
            } else { 
                interest = balance * r;
                if (i <= repayMonth && !earlyRepayApplied) { principal = principalMonth; curPay = principal + interest; } 
                else if (earlyRepayApplied) { principal = P_new / (n_orig - repayMonth + 1); curPay = principal + interest; }
            }
            
            balance -= principal;
            totalInt += interest;
            
            // è®°å½•æ™®é€šæœŸæ•°æ®
            window.currentScheduleData.push({ i: i, principal: principal.toFixed(2), interest: interest.toFixed(2), monthly: curPay.toFixed(2), balance: (balance<0?0:balance).toFixed(2) });

            if (i === repayMonth && repayAmount > 0 && balance > 0 && !earlyRepayApplied) {
                balance -= repayAmount;
                earlyRepayApplied = true; 
                P_new = balance; 
                
                if (type === 'equal_payment') {
                    if (recalculateOption === 'reduce_payment') {
                        let n_rem = n_orig - repayMonth; let term_new = Math.pow(1 + r, n_rem); monthly_new = P_new * r * term_new / (term_new - 1); n_new = n_orig; 
                    } else { 
                        monthly_new = monthly; let n_rem_float = -Math.log(1 - P_new * r / monthly_new) / Math.log(1 + r); n_new = repayMonth + Math.ceil(n_rem_float); 
                    }
                } else { P_new = P_new; n_new = n_orig; }

                // æ’å…¥æå‰è¿˜æ¬¾è¡Œ
                window.currentScheduleData.push({ i: i + "(æå‰è¿˜)", principal: repayAmount.toFixed(2), interest: "0.00", monthly: repayAmount.toFixed(2), balance: (balance<0?0:balance).toFixed(2) });
            }
            if (balance <= 0) break; 
        }

        totalPay = P_orig + totalInt;
        
        // æ˜¾ç¤ºç»“æœ
        if (earlyRepayApplied) {
            let interestSaved = (originalTotalInterest - totalInt) / 10000;
            let savingsText = `èŠ‚çœåˆ©æ¯: <strong>${interestSaved.toFixed(2)} ä¸‡å…ƒ</strong>`;
            if (recalculateOption === 'reduce_term' && type === 'equal_payment') savingsText += `ï¼ŒæœŸé™ç¼©çŸ­: <strong>${n_orig - n_new} ä¸ªæœˆ</strong>`;
            if (recalculateOption === 'reduce_payment' || type === 'equal_principal') savingsText += `ï¼Œæ–°æœˆä¾›/æœ¬é‡‘å‡å°‘`;
            document.getElementById('repaySavings').innerHTML = savingsText;
            document.getElementById('earlyRepayResult').style.display = 'block';
        } else {
            document.getElementById('earlyRepayResult').style.display = 'none';
        }

        document.getElementById('monthlyPayment').innerText = firstPay.toFixed(2) + " å…ƒ";
        document.getElementById('totalInterest').innerText = (totalInt/10000).toFixed(2) + " ä¸‡";
        document.getElementById('totalPayment').innerText = (totalPay/10000).toFixed(2) + " ä¸‡";
        
        // æ¸²æŸ“è¡¨æ ¼ HTML
        let scheduleHtml = window.currentScheduleData.map(d => `<tr><td>${d.i}</td><td>${d.principal}</td><td>${d.interest}</td><td>${d.monthly}</td><td>${d.balance}</td></tr>`).join('');
        document.querySelector('#scheduleTable tbody').innerHTML = scheduleHtml; 
        
        document.getElementById('loanResult').style.display = 'block';
        document.getElementById('scheduleBox').style.display = 'block';
        document.getElementById('chartBox').style.display = 'flex';

        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(document.getElementById('loanChart'), {
            type: 'doughnut',
            data: { labels: ['æœ¬é‡‘', 'æ€»åˆ©æ¯'], datasets: [{ data: [P_orig, totalInt], backgroundColor: ['#36A2EB', '#FF6384'] }] },
            options: { maintainAspectRatio: false }
        });
    }

    // ğŸ“¥ å¯¼å‡º CSV åŠŸèƒ½
    function exportCSV() {
        if(!window.currentScheduleData || window.currentScheduleData.length === 0) { alert('è¯·å…ˆè®¡ç®—åå†å¯¼å‡º'); return; }
        
        // CSV Header, æ·»åŠ  BOM \uFEFF é˜²æ­¢ Excel ä¸­æ–‡ä¹±ç 
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        csvContent += "æœŸæ•°,å¿è¿˜æœ¬é‡‘(å…ƒ),å¿è¿˜åˆ©æ¯(å…ƒ),æœ¬æœŸè¿˜æ¬¾æ€»é¢(å…ƒ),å‰©ä½™æœ¬é‡‘(å…ƒ)\n";
        
        window.currentScheduleData.forEach(row => {
            csvContent += `${row.i},${row.principal},${row.interest},${row.monthly},${row.balance}\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "æˆ¿è´·è¿˜æ¬¾è®¡åˆ’è¡¨.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    /* --- 2. åæ¨åˆ©ç‡ --- */
    function updateRevInputs() {
        let mode = document.getElementById('revMode').value;
        document.getElementById('inputInterest').style.display = (mode === 'target_interest' ? 'block' : 'none');
        document.getElementById('inputMonthly').style.display = (mode === 'target_monthly_payment' ? 'block' : 'none');
    }
    
    function calculateReverseRate() {
        let method = document.getElementById('revMethod').value;
        let mode = document.getElementById('revMode').value;
        let P = parseFloat(document.getElementById('revPrincipal').value) * 10000;
        let n = parseFloat(document.getElementById('revYears').value) * 12;
        
        if (isNaN(P) || isNaN(n) || P <= 0 || n <= 0) { alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æœ¬é‡‘å’ŒæœŸé™"); return; }
        
        let finalRate = 0, targetTotalPay = 0, calculatedMonthly = 0, calculatedInterest = 0;

        if (mode === 'target_interest') {
            let I = parseFloat(document.getElementById('revInterest').value) * 10000;
            if (isNaN(I) || I < 0) { alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ€»åˆ©æ¯"); return; }
            targetTotalPay = P + I;

            if (method === 'equal_principal') {
                finalRate = ((2 * I) / ((n + 1) * P)) * 12 * 100;
                calculatedMonthly = P / n + P * (finalRate/1200); // é¦–æœˆ
            } else {
                let min=0, max=1, guess=0;
                for(let i=0; i<100; i++) {
                    guess = (min+max)/2;
                    let term = Math.pow(1+guess, n);
                    let calc = (P * (guess*term)/(term-1)) * n;
                    if(Math.abs(calc - targetTotalPay) < 1) break;
                    if(calc > targetTotalPay) max = guess; else min = guess;
                }
                finalRate = guess * 12 * 100;
                calculatedMonthly = targetTotalPay / n; 
            }
            calculatedInterest = I;
            document.getElementById('revOtherResult').innerText = `å‚è€ƒæœˆä¾›: ${calculatedMonthly.toFixed(2)} å…ƒ`;

        } else {
            let A = parseFloat(document.getElementById('revMonthly').value);
            if (isNaN(A) || A <= 0) { alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æœˆä¾›"); return; }
            targetTotalPay = A * n;

            if (method === 'equal_principal') {
                let r = (A - P/n) / P; // é¦–æœˆæœˆä¾›æ¨ç®—
                finalRate = r * 12 * 100;
            } else {
                let min=0, max=1, guess=0;
                for(let i=0; i<100; i++) {
                    guess = (min+max)/2;
                    let term = Math.pow(1+guess, n);
                    let calcMonthly = P * (guess*term)/(term-1);
                    if(Math.abs(calcMonthly - A) < 0.01) break; 
                    if(calcMonthly > A) max = guess; else min = guess;
                }
                finalRate = guess * 12 * 100;
            }
            calculatedInterest = targetTotalPay - P;
            document.getElementById('revOtherResult').innerText = `æ€»åˆ©æ¯: ${(calculatedInterest/10000).toFixed(2)} ä¸‡å…ƒ`;
        }

        document.getElementById('revRateResult').innerText = finalRate.toFixed(3) + " %";
        document.getElementById('revTotalPay').innerText = (targetTotalPay/10000).toFixed(2) + " ä¸‡";
        document.getElementById('revResult').style.display = 'block';
    }

    /* --- 3. æ±‡ç‡ --- */
    const api = 'https://api.exchangerate-api.com/v4/latest/CNY';
    const cList = ['CNY','USD','EUR','HKD','JPY','GBP','AUD','CAD','SGD','KRW','THB','TWD','RUB','MYR','INR','CHF','SEK','NZD'];
    const cName = {'CNY':'ğŸ‡¨ğŸ‡³ äººæ°‘å¸','USD':'ğŸ‡ºğŸ‡¸ ç¾å…ƒ','EUR':'ğŸ‡ªğŸ‡º æ¬§å…ƒ','HKD':'ğŸ‡­ğŸ‡° æ¸¯å¸','JPY':'ğŸ‡¯ğŸ‡µ æ—¥å…ƒ','GBP':'ğŸ‡¬ğŸ‡§ è‹±é•‘','AUD':'ğŸ‡¦ğŸ‡º æ¾³å…ƒ','CAD':'ğŸ‡¨ğŸ‡¦ åŠ å…ƒ','SGD':'ğŸ‡¸ğŸ‡¬ æ–°å¸','KRW':'ğŸ‡°ğŸ‡· éŸ©å…ƒ','THB':'ğŸ‡¹ğŸ‡­ æ³°é“¢','TWD':'ğŸ‡¹ğŸ‡¼ å°å¸','RUB':'ğŸ‡·ğŸ‡º å¢å¸ƒ','MYR':'ğŸ‡²ğŸ‡¾ é©¬å¸','INR':'ğŸ‡®ğŸ‡³ å¢æ¯”','CHF':'ğŸ‡¨ğŸ‡­ ç‘éƒ','SEK':'ğŸ‡¸ğŸ‡ª ç‘å…¸å…‹æœ—','NZD':'ğŸ‡³ğŸ‡¿ æ–°è¥¿å…°å…ƒ'};
    const multiCurrencies = ['USD','EUR','JPY','GBP','HKD','KRW']; 
    let rates = {};

    async function fetchRates() {
        document.getElementById('rateStatus').innerText = "æ­£åœ¨æ›´æ–°...";
        try {
            let res = await fetch(api);
            let data = await res.json();
            rates = data.rates;
            window.ratesLoaded = true;
            let ops = cList.map(c => `<option value="${c}">${cName[c]||c} (${c})</option>`).join('');
            let s1 = document.getElementById('fromCurrency');
            let s2 = document.getElementById('toCurrency');
            if(s1.options.length===0) { s1.innerHTML = ops; s2.innerHTML = ops; s1.value='CNY'; s2.value='USD'; }
            document.getElementById('rateStatus').innerText = "æ›´æ–°æ—¶é—´: " + escapeHTML(data.date);
            calculateForex();
        } catch(e) { document.getElementById('rateStatus').innerText = "ç½‘ç»œé”™è¯¯"; }
    }
    function calculateForex() {
        if(!window.ratesLoaded) return;
        let amount = parseFloat(document.getElementById('forexAmount').value);
        if (isNaN(amount)) { document.getElementById('forexResult').value = ''; document.getElementById('forexMultiResult').innerHTML = ''; return; }
        
        let from = document.getElementById('fromCurrency').value;
        let to = document.getElementById('toCurrency').value;
        let res = (amount / rates[from]) * rates[to];
        document.getElementById('forexResult').value = res.toFixed(4);

        let multiHtml = '';
        multiCurrencies.forEach(targetCur => {
            if (targetCur !== from && targetCur !== to) {
                let multiRes = (amount / rates[from]) * rates[targetCur];
                multiHtml += `<div class="forex-item"><span>${cName[targetCur]} (${targetCur}):</span><strong>${multiRes.toFixed(4)}</strong></div>`;
            }
        });
        document.getElementById('forexMultiResult').innerHTML = multiHtml;
    }

    /* --- 4. ä¸‡èƒ½å•ä½ (ä¿®å¤æ•°æ®å•ä½ä¸º1024è¿›åˆ¶) --- */
    const uData = {
        // ä¿®å¤ï¼šæ•°æ®å•ä½ä¸¥æ ¼éµå¾ª 1024 è¿›ä½
        data: { 
            r: {'b': 1/1073741824, 'kb': 1/1048576, 'mb': 1/1024, 'gb': 1, 'tb': 1024, 'pb': 1048576}, 
            n: {'b':'å­—èŠ‚ (Byte)', 'kb':'KB', 'mb':'MB', 'gb':'GB', 'tb':'TB', 'pb':'PB'}, 
            base: 'gb' 
        },
        energy: { r: {'j':1, 'kj':1000, 'kwh':3600000, 'cal':4.184, 'kcal':4184, 'btu':1055.06}, n: {'j':'ç„¦è€³ (J)','kj':'åƒç„¦ (kJ)','kwh':'åƒç“¦æ—¶ (kWh)','cal':'å¡è·¯é‡Œ (cal)','kcal':'åƒå¡ (kcal)','btu':'è‹±çƒ­å•ä½ (BTU)'}, base: 'j' },
        time: { r: {'sec':1, 'min':60, 'hr':3600, 'day':86400, 'week':604800, 'year':31536000}, n: {'sec':'ç§’ (s)','min':'åˆ†é’Ÿ (min)','hr':'å°æ—¶ (h)','day':'å¤© (day)','week':'å‘¨ (week)','year':'å¹´ (year)'}, base: 'sec' },
        power: { r: {'w':1, 'kw':1000, 'hp':745.7, 'btus':1055.06}, n: {'w':'ç“¦ (W)','kw':'åƒç“¦ (kW)','hp':'é©¬åŠ›','btus':'è‹±çƒ­å•ä½/ç§’'}, base: 'w' },
        force: { r: {'n':1, 'kgn':9.80665, 'lbf':4.44822}, n: {'n':'ç‰›é¡¿ (N)','kgn':'åƒå…‹åŠ› (kgf)','lbf':'ç£…åŠ› (lbf)'}, base: 'n' },
        temperature: { r: {'c':1, 'f':1, 'k':1}, n: {'c':'æ‘„æ°åº¦ (Â°C)','f':'åæ°åº¦ (Â°F)','k':'å¼€å°”æ–‡ (K)'}, isSpecial: true },
        pressure: { r: {'pa':1, 'mpa':1000000, 'bar':100000, 'psi':6894.76, 'atm':101325, 'mmhg':133.322, 'torr':133.322}, n: {'pa':'å¸•æ–¯å¡ (Pa)','mpa':'å…†å¸• (MPa)','bar':'å·´ (Bar)','psi':'ç£…åŠ›/å¹³æ–¹è‹±å¯¸','atm':'æ ‡å‡†å¤§æ°”å‹','mmhg':'æ¯«ç±³æ±æŸ±','torr':'æ‰˜ (Torr)'}, base: 'pa' },
        flow: { r: {'m3s':1, 'm3h':0.000277778, 'lmin':0.000016667, 'gpm':0.00006309, 'cfm':0.000471947}, n: {'m3s':'ç«‹æ–¹ç±³/ç§’','m3h':'ç«‹æ–¹ç±³/å°æ—¶','lmin':'å‡/åˆ†','gpm':'åŠ ä»‘/åˆ†(ç¾)','cfm':'ç«‹æ–¹è‹±å°º/åˆ†'}, base: 'm3s' },
        velocity: { r: {'ms':1, 'kmh':0.277778, 'fts':0.3048, 'knot':0.51444}, n: {'ms':'ç±³/ç§’','kmh':'åƒç±³/å°æ—¶','fts':'è‹±å°º/ç§’','knot':'èŠ‚ (æµ·é‡Œ/æ—¶)'}, base: 'ms' },
        length: { r: {'m':1, 'km':1000, 'cm':0.01, 'mm':0.001, 'inch':0.0254, 'nmi':1852}, n: {'m':'ç±³','km':'åƒç±³','cm':'å˜ç±³','mm':'æ¯«ç±³','inch':'è‹±å¯¸','nmi':'æµ·é‡Œ'}, base: 'm' },
        weight: { r: {'kg':1, 'g':0.001, 't':1000, 'lb':0.453592}, n: {'kg':'åƒå…‹','g':'å…‹','t':'å¨','lb':'ç£…'}, base: 'kg' },
        area: { r: {'m2':1, 'ha':10000, 'acre':4046.86}, n: {'m2':'å¹³ç±³','ha':'å…¬é¡·','acre':'è‹±äº©'}, base: 'm2' },
        volume: { r: {'m3':1, 'l':0.001, 'gal':0.00378541}, n: {'m3':'ç«‹æ–¹ç±³','l':'å‡','gal':'åŠ ä»‘'}, base: 'm3' }
    };

    function updateUnitOptions() {
        let t = document.getElementById('unitType').value;
        let n = uData[t].n;
        let h = Object.keys(n).map(k => `<option value="${k}">${n[k]}</option>`).join('');
        document.getElementById('fromUnit').innerHTML = h;
        document.getElementById('toUnit').innerHTML = h;
        if(Object.keys(n).length>1) document.getElementById('toUnit').selectedIndex=1;
        convertUnit();
    }

    function convertTemperature(v, from, to) {
        let K; 
        switch(from) { case 'c': K = v + 273.15; break; case 'f': K = (v - 32) * 5/9 + 273.15; break; case 'k': K = v; break; default: return v; }
        switch(to) { case 'c': return K - 273.15; case 'f': return (K - 273.15) * 9/5 + 32; case 'k': return K; default: return K; }
    }

    function convertUnit() {
        let t = document.getElementById('unitType').value;
        let v = parseFloat(document.getElementById('inputVal').value);
        let f = document.getElementById('fromUnit').value;
        let to = document.getElementById('toUnit').value;
        if(isNaN(v)) { document.getElementById('outputVal').value=''; return; }
        let res = (t === 'temperature') ? convertTemperature(v, f, to) : (v * uData[t].r[f]) / uData[t].r[to];
        document.getElementById('outputVal').value = parseFloat(res.toPrecision(7));
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchRates(); updateUnitOptions(); updateRevInputs();
    });

</script>

</body>
</html>
