<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç»ˆæå…¨èƒ½è®¡ç®—å™¨ (Ultra Pro)</title>
    
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self'; 
                   script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; 
                   style-src 'self' 'unsafe-inline'; 
                   connect-src 'self' https://api.exchangerate-api.com; 
                   img-src 'self' data: https://flagcdn.com; 
                   object-src 'none'; 
                   frame-ancestors 'none';">

    <script>if(self!==top){top.location=self.location;}</script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- ğŸ¨ æ ¸å¿ƒ UI è®¾è®¡ --- */
        :root { 
            --primary: #007aff; --primary-dark: #005bb5; 
            --bg: #f2f6fa; --card: #ffffff; --text: #333;
            --shadow: 0 8px 24px rgba(0,0,0,0.06);
        }
        
        body { 
            font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif; 
            background-color: var(--bg); 
            display: flex; justify-content: center; 
            padding: 12px; margin: 0; color: var(--text); 
            -webkit-tap-highlight-color: transparent;
        }
        .container { 
            background: var(--card); width: 100%; max-width: 600px; 
            border-radius: 20px; box-shadow: var(--shadow); 
            overflow: hidden; display: flex; flex-direction: column; margin-bottom: 40px;
        }
        
        /* å¤´éƒ¨ */
        .header-section { padding: 18px; background: linear-gradient(180deg, #eaf4ff 0%, #fff 100%); text-align: center; border-bottom: 1px solid #eee; }
        .header-section h1 { margin: 0 0 4px; font-size: 20px; color: #005bb5; font-weight: 800; }
        .header-section p { margin: 0; font-size: 12px; color: #666; }

        /* ğŸ§­ å¯¼èˆªæ  (åŒæ’å®«æ ¼) */
        .nav-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; 
            padding: 12px; background: #fff; border-bottom: 1px solid #eee; 
        }
        .nav-btn { 
            padding: 10px 0; border: 1px solid #f0f0f0; background: #f8f9fa; 
            border-radius: 10px; font-size: 14px; font-weight: 600; color: #555; 
            cursor: pointer; transition: all 0.2s; 
        }
        .nav-btn.active { 
            background: #eff6ff; color: var(--primary); border-color: var(--primary); 
            box-shadow: 0 2px 5px rgba(0,122,255,0.1);
        }
        
        /* å†…å®¹åŒº */
        .content { padding: 20px 16px; display: none; animation: fadeIn 0.2s ease-out; }
        .content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(3px); } to { opacity: 1; transform: translateY(0); } }
        
        /* è¡¨å•æ§ä»¶ */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; color: #444; }
        
        /* é€šç”¨è¾“å…¥æ¡† */
        input, select { 
            width: 100%; padding: 12px; border: 1px solid #dce0e5; border-radius: 10px; 
            font-size: 16px; outline: none; box-sizing: border-box; background: #fff; appearance: none;
            transition: border 0.2s;
        }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,122,255,0.1); }
        
        /* æ±‡ç‡ç‰¹æ®Šå¸ƒå±€ï¼š[é‡‘é¢] [å›½æ——] [å¸ç§] */
        .forex-row { display: flex; align-items: center; gap: 8px; }
        .forex-row input { flex: 1; min-width: 0; font-weight: bold; color: var(--primary); }
        .forex-flag { width: 28px; height: 20px; border-radius: 3px; object-fit: cover; border: 1px solid #eee; }
        .forex-select { flex: 0 0 110px; } /* å›ºå®šå®½åº¦ */

        select { background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007aff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 10px center; background-size: 10px; padding-right: 25px; }

        /* æŒ‰é’® */
        button.action-btn { width: 100%; padding: 13px; background: linear-gradient(135deg, var(--primary), #0062cc); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 12px rgba(0,122,255,0.2); }
        button.action-btn:active { transform: scale(0.98); }
        button.reset-btn { background: #f0f2f5; color: #666; border: 1px solid #e1e4e8; margin-top: 10px; padding: 10px; width: 100%; border-radius: 10px; cursor: pointer; font-size: 14px; }
        button.export-btn { width: 100%; padding: 12px; background: #34c759; color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: bold; cursor: pointer; margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 6px; }
        
        /* ç»“æœå±•ç¤º */
        .result-box { margin-top: 20px; padding: 15px; background: #f7faff; border: 1px solid #dceeff; border-radius: 12px; display: none; }
        .result-item { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 15px; border-bottom: 1px dashed #e6e6e6; padding-bottom: 8px; }
        .result-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .result-item strong { color: #007aff; font-weight: 700; }
        
        /* ç‰¹æ®Šç»“æœæ¡† */
        .comparison-box { background: #fffcf0; border-color: #ffeeba; margin-top: 15px; }
        .comparison-box h4 { color: #b37400 !important; margin: 0 0 10px 0; }
        .comparison-box .result-item strong { color: #b37400; }
        .early-repay-result { background: #eaffea; border: 1px solid #c3e6cb; color: #155724; padding: 12px; border-radius: 8px; margin-top: 15px; font-size: 14px; display: none; }

        /* å¸ƒå±€ */
        .row-input { display: flex; gap: 10px; align-items: center; }
        .row-input input { flex: 2; }
        .row-input select { flex: 1; min-width: 0; } 
        
        /* å›¾è¡¨ */
        .chart-wrapper { position: relative; height: 240px; width: 100%; margin-top: 20px; display: none; justify-content: center; }

        /* è¡¨æ ¼ */
        .schedule-container { margin-top: 20px; max-height: 300px; overflow-y: auto; border: 1px solid #e1e4e8; border-radius: 8px; display: none; -webkit-overflow-scrolling: touch; }
        table.schedule-tbl { width: 100%; border-collapse: collapse; font-size: 12px; text-align: center; white-space: nowrap; }
        table.schedule-tbl th { background: #f8f9fa; padding: 10px; position: sticky; top: 0; z-index: 1; color: #555; border-bottom: 1px solid #ddd; }
        table.schedule-tbl td { padding: 8px; border-bottom: 1px solid #eee; color: #666; }
        
        /* æ±‡ç‡å¤šå¸ç§ */
        #forexMultiResult { margin-top: 15px; padding-top: 12px; border-top: 1px dashed #ddd; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px; color: #555; }
        .forex-item { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 6px 10px; border-radius: 6px; border: 1px solid #eee; }
        
        /* ğŸ§® ç§‘å­¦è®¡ç®—å™¨ */
        .calc-screen {
            width: 100%; height: 80px; background: #1c1c1e; color: #fff; border-radius: 12px;
            font-size: 36px; text-align: right; padding: 15px; box-sizing: border-box;
            margin-bottom: 12px; font-family: monospace; overflow-x: auto; white-space: nowrap;
            display: flex; align-items: center; justify-content: flex-end;
        }
        .calc-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .calc-btn {
            padding: 14px 0; font-size: 18px; font-weight: 500; border: none; border-radius: 8px;
            background: #e5e5e5; color: #000; cursor: pointer; transition: all 0.1s;
            display: flex; justify-content: center; align-items: center;
        }
        .calc-btn:active { transform: scale(0.92); filter: brightness(0.9); }
        .btn-op { background: #ff9f0a; color: white; font-size: 22px; font-weight: 600; }
        .btn-sci { background: #3a3a3c; color: #fff; font-size: 14px; font-weight: 600; }
        .btn-eq { background: var(--primary); color: white; grid-column: span 2; font-size: 24px; }
        .btn-ac { background: #ff453a; color: white; font-weight: 700; }
        .btn-del { background: #ff453a; color: white; font-size: 16px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <h1>ğŸš€ ç»ˆæå…¨èƒ½è®¡ç®—å™¨</h1>
        <p>å®‰å…¨æ— å¹¿ãƒ»ç§‘å­¦ç²¾å‡†ãƒ»å·¥ç¨‹åŠ©æ‰‹</p>
    </div>

    <div class="nav-grid">
        <button class="nav-btn active" onclick="switchTab('loan')">æˆ¿è´·è®¡ç®—</button>
        <button class="nav-btn" onclick="switchTab('reverse')">åæ¨åˆ©ç‡</button>
        <button class="nav-btn" onclick="switchTab('calc')">ç§‘å­¦è®¡ç®—</button>
        <button class="nav-btn" onclick="switchTab('forex')">æ±‡ç‡æ¢ç®—</button>
        <button class="nav-btn" onclick="switchTab('unit')">å·¥ç¨‹æ¢ç®—</button>
        <button class="nav-btn" onclick="switchTab('density')">æè´¨å¯†åº¦</button>
    </div>

    <div id="loan" class="content active">
        <div class="form-group">
            <label>è¿˜æ¬¾æ–¹å¼</label>
            <select id="repaymentMethod">
                <option value="equal_payment">ç­‰é¢æœ¬æ¯ (æ¯æœˆå›ºå®š)</option>
                <option value="equal_principal">ç­‰é¢æœ¬é‡‘ (é€æœˆé€’å‡)</option>
            </select>
        </div>
        <div class="row-input form-group">
            <div style="flex:1">
                <label>è´·æ¬¾é‡‘é¢ (ä¸‡å…ƒ)</label>
                <input type="number" id="loanAmount" placeholder="100" min="0" inputmode="decimal">
            </div>
            <div style="flex:1">
                <label>å¹´åˆ©ç‡ (%)</label>
                <input type="number" id="loanRate" placeholder="3.2" min="0" inputmode="decimal">
            </div>
        </div>
        <div class="form-group">
            <label>è´·æ¬¾æœŸé™ (å¹´)</label>
            <input type="number" id="loanYears" placeholder="30" min="1" inputmode="numeric">
        </div>

        <h4 style="margin: 20px 0 10px; font-size:14px; color:#555; border-left: 4px solid #ff9f0a; padding-left: 8px;">æå‰è¿˜æ¬¾ (å¯é€‰)</h4>
        <div class="row-input form-group">
            <div style="flex:1">
                <label>ç¬¬å‡ æœŸè¿˜æ¬¾</label>
                <input type="number" id="earlyRepayMonth" placeholder="å¦‚ 24" min="1" inputmode="numeric">
            </div>
            <div style="flex:1">
                <label>è¿˜æ¬¾é¢ (ä¸‡)</label>
                <input type="number" id="earlyRepayAmount" placeholder="å¦‚ 10" min="0" inputmode="decimal">
            </div>
        </div>
         <div class="form-group">
            <label>è¿˜æ¬¾åç­–ç•¥</label>
            <select id="recalculateOption">
                <option value="reduce_term">ç¼©çŸ­æœŸé™ (æœˆä¾›ä¸å˜)</option>
                <option value="reduce_payment">å‡å°‘æœˆä¾› (æœŸé™ä¸å˜)</option>
            </select>
        </div>
        
        <button class="action-btn" onclick="calculateLoan()">å¼€å§‹è®¡ç®—</button>
        <button class="reset-btn" onclick="resetInputs('loan')">é‡ç½®æ‰€æœ‰è¾“å…¥</button>

        <div id="comparisonResult" class="comparison-box result-box">
            <h4>ğŸ’° æ–¹å¼å¯¹æ¯” (æœ¬æ¯ vs æœ¬é‡‘)</h4>
            <div class="result-item"><span>æ€»åˆ©æ¯å·®ï¼š</span><strong id="compInterestDiff">0 ä¸‡</strong></div>
            <div class="result-item"><span>é¦–æœˆå·®é¢ï¼š</span><strong id="compFirstPayDiff">0 å…ƒ</strong></div>
        </div>

        <div id="loanResult" class="result-box">
            <div class="result-item"><span>é¦–æœˆæœˆä¾›ï¼š</span><strong id="monthlyPayment">0 å…ƒ</strong></div>
            <div class="result-item"><span>æ€»æ”¯ä»˜åˆ©æ¯ï¼š</span><strong id="totalInterest">0 ä¸‡</strong></div>
            <div class="result-item"><span>æœ¬æ¯åˆè®¡ï¼š</span><strong id="totalPayment">0 ä¸‡</strong></div>

            <div id="earlyRepayResult" class="early-repay-result"><span id="repaySavings"></span></div>
            <button class="export-btn" onclick="exportCSV()">ğŸ“¥ å¯¼å‡ºè®¡åˆ’è¡¨</button>

            <div class="chart-wrapper" id="chartBox"><canvas id="loanChart"></canvas></div>

            <h4 style="margin: 20px 0 10px; color:#555; border-left: 4px solid #007aff; padding-left: 8px;">æœˆåº¦æ˜ç»†</h4>
            <div class="schedule-container" id="scheduleBox">
                <table class="schedule-tbl" id="scheduleTable">
                    <thead><tr><th>æœŸæ•°</th><th>æœ¬é‡‘</th><th>åˆ©æ¯</th><th>æœˆä¾›</th><th>å‰©ä½™</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="reverse" class="content">
        <div style="background:#fffbf0; padding:12px; border-radius:8px; font-size:13px; color:#b37400; margin-bottom:15px; border:1px solid #ffeeba;">
            ğŸ’¡ å·²çŸ¥æ”¾æ¬¾é¢å’Œæœˆä¾›ï¼Œåç®—çœŸå®å¹´åŒ–åˆ©ç‡(IRR)ã€‚
        </div>
        <div class="form-group">
            <label>åæ¨æ¨¡å¼</label>
            <select id="revMode" onchange="updateRevInputs()">
                <option value="target_monthly_payment">å·²çŸ¥æœˆä¾› -> æ±‚åˆ©ç‡</option>
                <option value="target_interest">å·²çŸ¥æ€»åˆ©æ¯ -> æ±‚åˆ©ç‡</option>
            </select>
        </div>
        <div class="form-group">
            <label>è¿˜æ¬¾æ–¹å¼</label>
            <select id="revMethod">
                <option value="equal_payment">ç­‰é¢æœ¬æ¯</option>
                <option value="equal_principal">ç­‰é¢æœ¬é‡‘</option>
            </select>
        </div>
        <div class="row-input form-group">
            <div style="flex:1">
                <label>æœ¬é‡‘(ä¸‡)</label>
                <input type="number" id="revPrincipal" placeholder="100" min="0" inputmode="decimal">
            </div>
            <div style="flex:1">
                <label>æœŸé™(å¹´)</label>
                <input type="number" id="revYears" placeholder="30" min="1" inputmode="numeric">
            </div>
        </div>
        <div class="form-group" id="inputMonthly">
            <label>æœˆä¾›(å…ƒ)</label>
            <input type="number" id="revMonthly" placeholder="å¦‚ 4500" min="0" inputmode="decimal">
        </div>
        <div class="form-group" id="inputInterest" style="display:none;">
            <label>æ€»åˆ©æ¯(ä¸‡)</label>
            <input type="number" id="revInterest" placeholder="å¦‚ 0.7" min="0" inputmode="decimal">
        </div>
        <button class="action-btn" onclick="calculateReverseRate()">åå‘æ¨ç®—</button>
        <button class="reset-btn" onclick="resetInputs('reverse')">é‡ç½®è¾“å…¥</button>
        <div id="revResult" class="result-box reverse-box">
            <div class="result-item"><span>çœŸå®å¹´åŒ–åˆ©ç‡ï¼š</span><strong id="revRateResult" style="color:#ff3b30; font-size:1.3em;">0.00%</strong></div>
            <div class="result-item"><span>è¿˜æ¬¾æ€»é¢ï¼š</span><strong id="revTotalPay">0 ä¸‡</strong></div>
            <div class="result-item"><span>è¡¥å……ä¿¡æ¯ï¼š</span><strong id="revOtherResult">--</strong></div>
        </div>
    </div>

    <div id="calc" class="content">
        <div class="calc-screen" id="calcDisplay">0</div>
        <div class="calc-grid">
            <button class="calc-btn btn-ac" onclick="calcClear()">AC</button>
            <button class="calc-btn btn-del" onclick="calcDel()">âŒ«</button>
            <button class="calc-btn btn-sci" onclick="calcAppend('(')">(</button>
            <button class="calc-btn btn-sci" onclick="calcAppend(')')">)</button>
            <button class="calc-btn btn-op" onclick="calcAppend('/')">Ã·</button>
            
            <button class="calc-btn btn-sci" onclick="calcAppend('sin(')">sin</button>
            <button class="calc-btn btn-sci" onclick="calcAppend('cos(')">cos</button>
            <button class="calc-btn btn-sci" onclick="calcAppend('tan(')">tan</button>
            <button class="calc-btn btn-sci" onclick="calcAppend('log(')">log</button>
            <button class="calc-btn btn-op" onclick="calcAppend('*')">Ã—</button>

            <button class="calc-btn" onclick="calcAppend('7')">7</button>
            <button class="calc-btn" onclick="calcAppend('8')">8</button>
            <button class="calc-btn" onclick="calcAppend('9')">9</button>
            <button class="calc-btn btn-sci" onclick="calcAppend('ln(')">ln</button>
            <button class="calc-btn btn-op" onclick="calcAppend('-')">-</button>

            <button class="calc-btn" onclick="calcAppend('4')">4</button>
            <button class="calc-btn" onclick="calcAppend('5')">5</button>
            <button class="calc-btn" onclick="calcAppend('6')">6</button>
            <button class="calc-btn btn-sci" onclick="calcAppend('^')">^</button>
            <button class="calc-btn btn-op" onclick="calcAppend('+')">+</button>

            <button class="calc-btn" onclick="calcAppend('1')">1</button>
            <button class="calc-btn" onclick="calcAppend('2')">2</button>
            <button class="calc-btn" onclick="calcAppend('3')">3</button>
            <button class="calc-btn btn-sci" onclick="calcAppend('sqrt(')">âˆš</button>
            <button class="calc-btn btn-sci" onclick="calcAppend('Ï€')">Ï€</button>

            <button class="calc-btn btn-sci" onclick="calcAppend('e')">e</button>
            <button class="calc-btn" onclick="calcAppend('0')">0</button>
            <button class="calc-btn" onclick="calcAppend('.')">.</button>
            <button class="calc-btn btn-eq" onclick="calcResult()">=</button>
        </div>
    </div>

    <div id="forex" class="content">
        <div class="form-group">
            <label>æŒæœ‰é‡‘é¢</label>
            <div class="forex-row">
                <input type="number" id="forexAmount" value="100" oninput="calculateForex()" inputmode="decimal">
                <img id="fromFlag" class="forex-flag" src="https://flagcdn.com/w40/cn.png">
                <select id="fromCurrency" class="forex-select" onchange="updateFlags(); calculateForex()"></select>
            </div>
        </div>
        <div style="text-align:center; color:#aaa; margin: 5px 0;">â¬‡ï¸</div>
        <div class="form-group">
            <label>ç›®æ ‡è´§å¸</label>
            <div class="forex-row">
                <input type="text" id="forexResult" readonly style="background:#f9f9f9; color:var(--primary);">
                <img id="toFlag" class="forex-flag" src="https://flagcdn.com/w40/us.png">
                <select id="toCurrency" class="forex-select" onchange="updateFlags(); calculateForex()"></select>
            </div>
        </div>
        <p style="text-align:center; font-size:12px; color:#999; margin-top:8px;" id="rateStatus">åŠ è½½ä¸­...</p>
        <button class="action-btn" onclick="fetchRates()" style="background:#34c759;">åˆ·æ–°æ±‡ç‡</button>

        <h4 style="margin: 25px 0 10px; font-size:14px; color:#555; border-left: 4px solid #34c759; padding-left: 8px;">å‚è€ƒæ±‡ç‡ (å«äººæ°‘å¸)</h4>
        <div id="forexMultiResult"></div>
    </div>

    <div id="unit" class="content">
        <div class="form-group">
            <label>é€‰æ‹©ç±»å‹</label>
            <select id="unitType" onchange="updateUnitOptions()">
                <option value="length">ğŸ“ é•¿åº¦ (å«é‡Œ/ä¸ˆ/å°º)</option>
                <option value="area">â¬› é¢ç§¯ (å«äº©/é¡·)</option>
                <option value="weight">âš–ï¸ é‡é‡ (å«æ–¤/ä¸¤)</option>
                <option value="volume">ğŸ§Š ä½“ç§¯ (Volume)</option>
                <option value="pressure">ğŸŒ¡ï¸ å‹åŠ› (Pressure)</option>
                <option value="flow">ğŸ’§ æµé‡ (Flow)</option>
                <option value="power">âš¡ åŠŸç‡ (Power)</option> 
                <option value="energy">ğŸ”‹ èƒ½é‡ (Energy)</option>
                <option value="speed">ğŸš€ é€Ÿåº¦ (Speed)</option>
                <option value="time">â³ æ—¶é—´ (Time)</option>
                <option value="data">ğŸ’¾ æ•°æ® (1024è¿›åˆ¶)</option>
                <option value="temperature">ğŸ”¥ æ¸©åº¦ (Temp)</option>
            </select>
        </div>
        <div class="form-group">
            <label>è¾“å…¥</label>
            <div class="row-input">
                <input type="number" id="inputVal" placeholder="è¾“å…¥æ•°å€¼" oninput="convertUnit()" inputmode="decimal">
                <select id="fromUnit" onchange="convertUnit()"></select>
            </div>
        </div>
        <div class="form-group">
            <label>ç»“æœ</label>
            <div class="row-input">
                <input type="text" id="outputVal" readonly style="background:#f9f9f9; font-weight:bold; color:var(--primary);">
                <select id="toUnit" onchange="convertUnit()"></select>
            </div>
        </div>
    </div>
    
    <div id="density" class="content">
        <div class="form-group">
            <label>é€‰æ‹©ææ–™ (å»ºç­‘/é‡‘å±/ç”Ÿæ´»)</label>
            <select id="materialSelect" onchange="queryDensity()"></select>
        </div>
        <button class="action-btn" onclick="queryDensity()" style="background: linear-gradient(135deg, #34c759, #218838);">æŸ¥è¯¢å¯†åº¦</button>
        <div id="densityResult" class="result-box" style="background:#f4fbf6; border-color:#bceac3;">
            <div class="result-item"><span>ææ–™åç§°ï¼š</span><strong id="densityName">--</strong></div>
            <div class="result-item"><span>å¯†åº¦ (kg/mÂ³)ï¼š</span><strong id="densityKGM3">--</strong></div>
            <div class="result-item"><span>å¯†åº¦ (g/cmÂ³)ï¼š</span><strong id="densityGCM3">--</strong></div>
            <div class="result-item" id="densityNoteBox" style="display:none; border:none;"><span style="font-size:12px; color:#666;">* æ³¨: å®é™…å¯†åº¦å—å«æ°´ç‡/äº§åœ°å½±å“</span></div>
        </div>
    </div>
</div>

<script>
    /* --- å…¨å±€é€»è¾‘ --- */
    window.currentScheduleData = []; 

    function switchTab(name) {
        document.querySelectorAll('.content').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        const btns = document.querySelectorAll('.nav-btn');
        btns.forEach(btn => {
            if(btn.getAttribute('onclick').includes(name)) btn.classList.add('active');
        });
        document.getElementById(name).classList.add('active');
        if(name === 'forex' && !window.ratesLoaded) fetchRates(); 
    }

    function resetInputs(id) {
        document.querySelectorAll(`#${id} input`).forEach(i => i.value = '');
        document.querySelectorAll(`#${id} .result-box`).forEach(b => b.style.display = 'none');
    }

    /* --- ğŸ§® ç§‘å­¦è®¡ç®—å™¨ (å®‰å…¨é€»è¾‘) --- */
    let calcExpr = "";
    function calcAppend(val) {
        if(val === '.' && calcExpr.endsWith('.')) return;
        if(calcExpr === "Error" || calcExpr === "Infinity") calcExpr = "";
        calcExpr += val;
        document.getElementById('calcDisplay').innerText = calcExpr;
    }
    function calcClear() { calcExpr = ""; document.getElementById('calcDisplay').innerText = "0"; }
    function calcDel() { calcExpr = calcExpr.slice(0, -1); document.getElementById('calcDisplay').innerText = calcExpr || "0"; }
    function calcResult() {
        try {
            if(calcExpr === "") return;
            let evalStr = calcExpr
                .replace(/Ã—/g, '*')
                .replace(/Ã·/g, '/')
                .replace(/\^/g, '**')
                .replace(/Ï€/g, 'Math.PI')
                .replace(/e/g, 'Math.E')
                .replace(/sin\(/g, 'Math.sin(')
                .replace(/cos\(/g, 'Math.cos(')
                .replace(/tan\(/g, 'Math.tan(')
                .replace(/log\(/g, 'Math.log10(')
                .replace(/ln\(/g, 'Math.log(')
                .replace(/sqrt\(/g, 'Math.sqrt(');

            if (!/^[0-9.\+\-\*\/\%\(\)\s(Math\.)]+$/.test(evalStr)) throw "Sec";

            let result = new Function('return ' + evalStr)();
            if(!isFinite(result)) throw "Err";
            result = parseFloat(result.toPrecision(12));
            calcExpr = result.toString();
            document.getElementById('calcDisplay').innerText = calcExpr;
        } catch(e) {
            calcExpr = "";
            document.getElementById('calcDisplay').innerText = "Error";
        }
    }

    /* --- ğŸ  æˆ¿è´·è®¡ç®— --- */
    let chartInstance = null;
    function calculateLoan() {
        window.currentScheduleData = [];
        let P = parseFloat(document.getElementById('loanAmount').value) * 10000;
        let R = parseFloat(document.getElementById('loanRate').value) / 100 / 12;
        let N = parseFloat(document.getElementById('loanYears').value) * 12;
        let type = document.getElementById('repaymentMethod').value;
        
        if(isNaN(P) || isNaN(R) || isNaN(N) || P<=0 || R<0 || N<=0) { alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å€¼"); return; }

        let eMonth = parseInt(document.getElementById('earlyRepayMonth').value);
        let eAmount = parseFloat(document.getElementById('earlyRepayAmount').value) * 10000;
        let eType = document.getElementById('recalculateOption').value;
        let isEarly = (eMonth > 0 && eAmount >= 0 && eMonth < N);

        let diff = compareLoans(P, R, N);
        document.getElementById('compInterestDiff').innerText = (diff.int/10000).toFixed(2) + " ä¸‡";
        document.getElementById('compFirstPayDiff').innerText = diff.first.toFixed(2) + " å…ƒ";
        document.getElementById('comparisonResult').style.display = 'block';

        let balance = P, totalInt = 0, monthly = 0;
        let schedule = [], pNew = 0, nNew = N, monthlyNew = 0;
        let hasEarlyPay = false;

        if(type === 'equal_payment') {
            let k = Math.pow(1+R, N);
            monthly = P * R * k / (k-1);
        }

        for(let i=1; i<=N; i++) {
            let int = balance * R;
            let prin = 0, curPay = 0;

            if(type === 'equal_payment') {
                if(!hasEarlyPay) { prin = monthly - int; curPay = monthly; } 
                else {
                    if(eType === 'reduce_payment') { prin = monthlyNew - int; curPay = monthlyNew; } 
                    else { if(i > nNew) break; prin = monthlyNew - int; curPay = monthlyNew; }
                }
            } else {
                if(!hasEarlyPay) prin = P / N;
                else prin = pNew / (N - eMonth); 
                curPay = prin + int;
            }

            if(balance - prin < 0.1) { prin = balance; curPay = prin + int; balance = 0; }
            else { balance -= prin; }

            totalInt += int;
            schedule.push({i, prin, int, pay: curPay, bal: balance});

            if(isEarly && i === eMonth) {
                balance -= eAmount; if(balance < 0) balance = 0;
                hasEarlyPay = true; pNew = balance;
                schedule.push({i: i+"(æå‰)", prin: eAmount, int: 0, pay: eAmount, bal: balance});

                if(balance > 0) {
                    if(type === 'equal_payment') {
                        if(eType === 'reduce_payment') {
                            let remMonths = N - eMonth; let k = Math.pow(1+R, remMonths);
                            monthlyNew = balance * R * k / (k-1);
                        } else {
                            monthlyNew = monthly;
                            let temp = 1 - (balance * R / monthly);
                            if(temp <= 0) { nNew = i; balance = 0; }
                            else { let remN = -Math.log(temp) / Math.log(1+R); nNew = i + Math.ceil(remN); }
                        }
                    }
                } else break;
            }
            if(balance <= 0) break;
        }
        
        window.currentScheduleData = schedule;
        let firstPay = schedule[0] ? schedule[0].pay : 0;
        let totalPay = P + totalInt;
        
        document.getElementById('monthlyPayment').innerText = firstPay.toFixed(2) + " å…ƒ";
        document.getElementById('totalInterest').innerText = (totalInt/10000).toFixed(2) + " ä¸‡";
        document.getElementById('totalPayment').innerText = (totalPay/10000).toFixed(2) + " ä¸‡";

        if(hasEarlyPay) {
            let orgInt = 0;
            if(type === 'equal_payment') orgInt = (monthly * N) - P;
            else orgInt = (N+1)*P*R/2;
            let save = (orgInt - totalInt)/10000;
            document.getElementById('repaySavings').innerText = `âš¡ï¸ èŠ‚çœçº¦ ${save.toFixed(2)} ä¸‡å…ƒåˆ©æ¯`;
            document.getElementById('earlyRepayResult').style.display = 'block';
        } else {
            document.getElementById('earlyRepayResult').style.display = 'none';
        }

        let html = schedule.map(r => `<tr><td>${r.i}</td><td>${r.prin.toFixed(2)}</td><td>${r.int.toFixed(2)}</td><td>${r.pay.toFixed(2)}</td><td>${r.bal.toFixed(2)}</td></tr>`).join('');
        document.querySelector('#scheduleTable tbody').innerHTML = html;

        document.getElementById('loanResult').style.display = 'block';
        document.getElementById('scheduleBox').style.display = 'block';
        document.getElementById('chartBox').style.display = 'flex';
        
        if(chartInstance) { chartInstance.destroy(); }
        chartInstance = new Chart(document.getElementById('loanChart'), {
            type: 'doughnut',
            data: { labels: ['æœ¬é‡‘', 'æ€»åˆ©æ¯'], datasets: [{ data: [P, totalInt], backgroundColor: ['#007aff', '#ffcc00'] }] },
            options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function compareLoans(P, r, n) {
        let k = Math.pow(1+r, n);
        let m1 = P*r*k/(k-1);
        let int1 = m1*n - P;
        let int2 = (n+1)*P*r/2;
        let m2 = P/n + P*r;
        return { int: Math.abs(int1-int2), first: Math.abs(m1-m2) };
    }

    function exportCSV() {
        if(window.currentScheduleData.length === 0) { alert('è¯·å…ˆè®¡ç®—'); return; }
        let csv = "\uFEFFæœŸæ•°,æœ¬é‡‘,åˆ©æ¯,æœˆä¾›,å‰©ä½™\n";
        window.currentScheduleData.forEach(r => csv += `${r.i},${r.prin.toFixed(2)},${r.int.toFixed(2)},${r.pay.toFixed(2)},${r.bal.toFixed(2)}\n`);
        let blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        let link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "æˆ¿è´·è®¡åˆ’.csv";
        link.click();
    }

    /* --- ğŸ’± æ±‡ç‡ (æ ¸å¿ƒä¿®å¤: å›½æ—— + CNY å¼ºåˆ¶æ˜¾ç¤º) --- */
    const cNameMap = { 'CNY':'äººæ°‘å¸','USD':'ç¾å…ƒ','EUR':'æ¬§å…ƒ','HKD':'æ¸¯å¸','JPY':'æ—¥å…ƒ', 'GBP':'è‹±é•‘','AUD':'æ¾³å…ƒ','CAD':'åŠ å…ƒ','SGD':'æ–°å¸','KRW':'éŸ©å…ƒ', 'THB':'æ³°é“¢','TWD':'å°å¸','RUB':'å¢å¸ƒ','MYR':'é©¬å¸','INR':'å¢æ¯”', 'CHF':'ç‘éƒ','NZD':'æ–°è¥¿å…°å…ƒ' };
    const countryCodes = { 'CNY':'cn','USD':'us','EUR':'eu','HKD':'hk','JPY':'jp','GBP':'gb','AUD':'au', 'CAD':'ca','SGD':'sg','KRW':'kr','THB':'th','TWD':'tw','RUB':'ru','MYR':'my', 'INR':'in','CHF':'ch','NZD':'nz' };
    let rates = {};

    async function fetchRates() {
        try {
            let res = await fetch('https://api.exchangerate-api.com/v4/latest/CNY');
            let data = await res.json();
            rates = data.rates;
            window.ratesLoaded = true;
            document.getElementById('rateStatus').innerText = "æ›´æ–°: " + data.date;
            
            let html = Object.keys(cNameMap).map(c => `<option value="${c}">${c}</option>`).join('');
            if(document.getElementById('fromCurrency').innerHTML === "") {
                document.getElementById('fromCurrency').innerHTML = html;
                document.getElementById('toCurrency').innerHTML = html;
                document.getElementById('fromCurrency').value = 'CNY';
                document.getElementById('toCurrency').value = 'USD';
                updateFlags();
            }
            calculateForex();
        } catch(e) { document.getElementById('rateStatus').innerText = "æ±‡ç‡åŠ è½½å¤±è´¥"; }
    }

    function updateFlags() {
        let f = document.getElementById('fromCurrency').value;
        let t = document.getElementById('toCurrency').value;
        document.getElementById('fromFlag').src = `https://flagcdn.com/w40/${countryCodes[f]}.png`;
        document.getElementById('toFlag').src = `https://flagcdn.com/w40/${countryCodes[t]}.png`;
    }

    function calculateForex() {
        if(!window.ratesLoaded) return;
        let amt = parseFloat(document.getElementById('forexAmount').value);
        if(isNaN(amt)) return;
        let f = document.getElementById('fromCurrency').value;
        let t = document.getElementById('toCurrency').value;
        let val = (amt / rates[f]) * rates[t];
        document.getElementById('forexResult').value = val.toFixed(4) + " " + t;

        // æ™ºèƒ½åˆ—è¡¨ï¼šå¦‚æœé RMB å…‘æ¢ï¼Œå¼ºåˆ¶æ˜¾ç¤º RMB
        let others = ['USD','EUR','JPY','HKD','GBP','CNY'].filter(c => c!==f && c!==t);
        // å»é‡
        others = [...new Set(others)];
        
        let html = others.map(c => {
            let v = (amt / rates[f]) * rates[c];
            return `<div class="forex-item"><span><img src="https://flagcdn.com/w20/${countryCodes[c]}.png" style="vertical-align:middle;margin-right:5px;width:16px;">${cNameMap[c]}</span><strong>${v.toFixed(4)}</strong></div>`
        }).join('');
        document.getElementById('forexMultiResult').innerHTML = html;
    }

    /* --- âš–ï¸ ä¸‡èƒ½å•ä½ --- */
    const uData = {
        length: { r: { 'm':1, 'km':1000, 'cm':0.01, 'mm':0.001, 'inch':0.0254, 'ft':0.3048, 'mi':1609.34, 'nmi':1852, 'li':500, 'zhang':3.333333, 'chi':0.333333, 'cun':0.033333 }, n: { 'm':'ç±³', 'km':'åƒç±³', 'cm':'å˜ç±³', 'mm':'æ¯«ç±³', 'inch':'è‹±å¯¸', 'ft':'è‹±å°º', 'mi':'è‹±é‡Œ', 'nmi':'æµ·é‡Œ', 'li':'é‡Œ(å¸‚)', 'zhang':'ä¸ˆ', 'chi':'å°º', 'cun':'å¯¸' } },
        area: { r: { 'm2':1, 'km2':1000000, 'ha':10000, 'acre':4046.86, 'sqft':0.092903, 'mu':666.666667, 'fen':66.666667, 'qing':66666.6667 }, n: { 'm2':'å¹³æ–¹ç±³', 'km2':'å¹³æ–¹åƒç±³', 'ha':'å…¬é¡·', 'acre':'è‹±äº©', 'sqft':'å¹³æ–¹è‹±å°º', 'mu':'äº©(å¸‚)', 'fen':'åˆ†(å¸‚)', 'qing':'é¡·' } },
        weight: { r: { 'kg':1, 'g':0.001, 'mg':0.000001, 't':1000, 'lb':0.453592, 'oz':0.0283495, 'jin':0.5, 'liang':0.05, 'dan':50 }, n: { 'kg':'åƒå…‹', 'g':'å…‹', 'mg':'æ¯«å…‹', 't':'å¨', 'lb':'ç£…', 'oz':'ç›å¸', 'jin':'æ–¤(å¸‚)', 'liang':'ä¸¤', 'dan':'æ‹…' } },
        volume: { r: { 'l':1, 'ml':0.001, 'm3':1000, 'gal':3.78541, 'pt':0.473176 }, n: { 'l':'å‡', 'ml':'æ¯«å‡', 'm3':'ç«‹æ–¹ç±³', 'gal':'ç¾åˆ¶åŠ ä»‘', 'pt':'å“è„±' } },
        pressure: { r: { 'pa':1, 'kpa':1000, 'mpa':1000000, 'bar':100000, 'psi':6894.76, 'atm':101325, 'mmhg':133.322 }, n: { 'pa':'å¸•æ–¯å¡', 'kpa':'åƒå¸•', 'mpa':'å…†å¸•', 'bar':'å·´', 'psi':'PSI', 'atm':'æ ‡å‡†å¤§æ°”å‹', 'mmhg':'æ¯«ç±³æ±æŸ±' } },
        energy: { r: { 'j':1, 'kj':1000, 'cal':4.184, 'kcal':4184, 'kwh':3600000, 'btu':1055.06 }, n: { 'j':'ç„¦è€³', 'kj':'åƒç„¦', 'cal':'å¡è·¯é‡Œ', 'kcal':'åƒå¡', 'kwh':'åƒç“¦æ—¶', 'btu':'è‹±çƒ­' } },
        power: { r: { 'w':1, 'kw':1000, 'hp':745.7 }, n: { 'w':'ç“¦ç‰¹', 'kw':'åƒç“¦', 'hp':'é©¬åŠ›' } },
        time: { r: { 's':1, 'min':60, 'h':3600, 'day':86400, 'week':604800, 'yr':31536000 }, n: { 's':'ç§’', 'min':'åˆ†', 'h':'å°æ—¶', 'day':'å¤©', 'week':'å‘¨', 'yr':'å¹´' } },
        speed: { r: { 'ms':1, 'kmh':0.277778, 'mph':0.44704, 'kn':0.514444, 'mach':340.3 }, n: { 'ms':'ç±³/ç§’', 'kmh':'åƒç±³/æ—¶', 'mph':'è‹±é‡Œ/æ—¶', 'kn':'èŠ‚', 'mach':'é©¬èµ«' } },
        data: { r: { 'b':1, 'kb':1024, 'mb':1048576, 'gb':1073741824, 'tb':1099511627776 }, n: { 'b':'Byte', 'kb':'KB', 'mb':'MB', 'gb':'GB', 'tb':'TB' } },
        flow: { r: {'m3s':1, 'm3h':0.000277778, 'lmin':0.000016667, 'gpm':0.00006309}, n: {'m3s':'ç«‹æ–¹ç±³/ç§’','m3h':'ç«‹æ–¹ç±³/æ—¶','lmin':'å‡/åˆ†','gpm':'åŠ ä»‘/åˆ†'} },
        temperature: { isTemp: true, n: {'c':'æ‘„æ°åº¦Â°C', 'f':'åæ°åº¦Â°F', 'k':'å¼€å°”æ–‡K'} }
    };

    function updateUnitOptions() {
        let type = document.getElementById('unitType').value;
        let data = uData[type];
        let html = Object.keys(data.n).map(k => `<option value="${k}">${data.n[k]}</option>`).join('');
        document.getElementById('fromUnit').innerHTML = html;
        document.getElementById('toUnit').innerHTML = html;
        if(document.getElementById('toUnit').options.length > 1) document.getElementById('toUnit').selectedIndex = 1;
        convertUnit();
    }

    function convertUnit() {
        let type = document.getElementById('unitType').value;
        let val = parseFloat(document.getElementById('inputVal').value);
        let f = document.getElementById('fromUnit').value;
        let t = document.getElementById('toUnit').value;
        if(isNaN(val)) { document.getElementById('outputVal').value = ""; return; }
        let res = 0;
        if(uData[type].isTemp) {
            let k = 0;
            if(f==='c') k = val + 273.15; else if(f==='f') k = (val - 32)*5/9 + 273.15; else k = val;
            if(t==='c') res = k - 273.15; else if(t==='f') res = (k - 273.15)*9/5 + 32; else res = k;
        } else {
            let r = uData[type].r;
            res = val * r[f] / r[t];
        }
        if(Math.abs(res) < 0.000001 || Math.abs(res) > 1e9) document.getElementById('outputVal').value = res.toExponential(4);
        else document.getElementById('outputVal').value = parseFloat(res.toPrecision(7));
    }

    /* --- ğŸ”¬ æè´¨å¯†åº¦ --- */
    const densities = {
        'select': {n:'--- è¯·é€‰æ‹© ---', d:0},
        'cement_loose': {n:'æ°´æ³¥ (æ•£è£…)', d:1440}, 'sand_dry': {n:'å¹²æ²™', d:1600}, 'sand_wet': {n:'æ¹¿æ²™', d:1900},
        'gravel': {n:'ç¢çŸ³', d:1500}, 'concrete': {n:'æ™®é€šæ··å‡åœŸ', d:2400}, 'concrete_steel': {n:'é’¢ç­‹æ··å‡åœŸ', d:2500},
        'brick': {n:'æ™®é€šçº¢ç –', d:1800}, 'granite': {n:'èŠ±å²—å²©', d:2700}, 'marble': {n:'å¤§ç†çŸ³', d:2600}, 'glass': {n:'ç»ç’ƒ', d:2500},
        'steel': {n:'é’¢ (ç¢³é’¢)', d:7850}, 'stainless': {n:'ä¸é”ˆé’¢ (304)', d:7930}, 'iron': {n:'çº¯é“', d:7874}, 'alum': {n:'é“', d:2700},
        'copper': {n:'é“œ', d:8960}, 'brass': {n:'é»„é“œ', d:8500}, 'gold': {n:'é»„é‡‘', d:19320}, 'silver': {n:'é“¶', d:10490},
        'water': {n:'çº¯æ°´ (4Â°C)', d:1000}, 'sea': {n:'æµ·æ°´', d:1025}, 'ice': {n:'å†°', d:917}, 'oil_veg': {n:'æ¤ç‰©æ²¹', d:920},
        'petrol': {n:'æ±½æ²¹', d:730}, 'diesel': {n:'æŸ´æ²¹', d:840}, 'milk': {n:'ç‰›å¥¶', d:1030}, 'alcohol': {n:'ä¹™é†‡', d:789}, 'air': {n:'ç©ºæ°”', d:1.204}
    };

    function initDensity() {
        let html = "";
        for(let k in densities) html += `<option value="${k}">${densities[k].n}</option>`;
        document.getElementById('materialSelect').innerHTML = html;
    }

    function queryDensity() {
        let key = document.getElementById('materialSelect').value;
        if(key === 'select') { document.getElementById('densityResult').style.display = 'none'; return; }
        let d = densities[key].d;
        document.getElementById('densityName').innerText = densities[key].n;
        document.getElementById('densityKGM3').innerText = d;
        document.getElementById('densityGCM3').innerText = (d/1000).toFixed(3);
        document.getElementById('densityResult').style.display = 'block';
        document.getElementById('densityNoteBox').style.display = 'block';
    }

    /* --- ğŸ“‰ åæ¨åˆ©ç‡ --- */
    function calculateReverseRate() {
        let mode = document.getElementById('revMode').value;
        let method = document.getElementById('revMethod').value;
        let P = parseFloat(document.getElementById('revPrincipal').value) * 10000;
        let n = parseFloat(document.getElementById('revYears').value) * 12;
        if(isNaN(P) || isNaN(n) || P<=0 || n<=0) { alert("è¯·è¾“å…¥æœ‰æ•ˆæ•°å€¼"); return; }
        let targetMonthly = 0;
        let totalPay = 0;
        if(mode === 'target_monthly_payment') {
            targetMonthly = parseFloat(document.getElementById('revMonthly').value);
            if(isNaN(targetMonthly)) return;
            totalPay = targetMonthly * n;
        } else {
            let totalInt = parseFloat(document.getElementById('revInterest').value) * 10000;
            if(isNaN(totalInt)) return;
            totalPay = P + totalInt;
            targetMonthly = totalPay / n; 
        }
        let rate = 0;
        if(method === 'equal_principal') {
            let intVal = totalPay - P;
            rate = (2 * intVal) / ((n+1)*P) * 12;
        } else {
            let min = 0, max = 1; 
            for(let i=0; i<50; i++) {
                let mid = (min+max)/2;
                let k = Math.pow(1+mid, n);
                let m = P*mid*k/(k-1);
                if(mode === 'target_monthly_payment') { if(m > targetMonthly) max = mid; else min = mid; } 
                else { if(m*n > totalPay) max = mid; else min = mid; }
            }
            rate = min * 12;
        }
        document.getElementById('revRateResult').innerText = (rate*100).toFixed(3) + "%";
        document.getElementById('revTotalPay').innerText = (totalPay/10000).toFixed(2) + " ä¸‡";
        let note = mode === 'target_monthly_payment' ? `æ€»åˆ©æ¯: ${((totalPay-P)/10000).toFixed(2)}ä¸‡` : `å‚è€ƒæœˆä¾›: ${targetMonthly.toFixed(0)}å…ƒ`;
        document.getElementById('revOtherResult').innerText = note;
        document.getElementById('revResult').style.display = 'block';
    }
    function updateRevInputs() {
        let mode = document.getElementById('revMode').value;
        document.getElementById('inputMonthly').style.display = mode === 'target_monthly_payment' ? 'block' : 'none';
        document.getElementById('inputInterest').style.display = mode === 'target_interest' ? 'block' : 'none';
    }

    /* --- åˆå§‹åŒ– --- */
    window.onload = function() {
        updateUnitOptions(); 
        updateRevInputs();
        initDensity();
    };
</script>

</body>
</html>
